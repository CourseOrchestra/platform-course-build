<!DOCTYPE html>
<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Защита от потерянных обновлений :: Платформа КУРС</title>
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">Платформа КУРС</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Поиск">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../../index.html"><img src="../../_/img/course-orchestra-logo.svg" width="60rem"></a>
        <!--div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div-->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="celesta" data-version="7">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="1010_what_is_celesta.html">Челеста</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1010_what_is_celesta.html">Что такое Celesta?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1012_demo.html">Демонстрационный пример</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1013_maven_plugin.html">Maven-плагин</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1015_vocabulary.html">Словарь основных понятий Celesta</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1020_celesta_start.html">Операции, выполняемые при инициализации Celesta</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1030_basic_settings.html">Параметры конфигурации Celesta</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1040_system_tables.html">Системные таблицы Celesta</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1050_celesta_sql.html">Язык Celesta-SQL</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1060_celesta_doc.html">CelestaDoc</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1065_celesta_instantiation.html">Создание экземпляра Celesta</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1070_call_context.html">Контекст вызова</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1080_data_accessors.html">Работа с данными через классы доступа к данным (курсоры)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1088_security_logging.html">Распределение прав доступа и протоколирование изменений</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1090_blob.html">BLOB-поля</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1100_option.html">Options-поля</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1102_dynamic.html">Динамический доступ к данным</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1105_triggers.html">Триггеры</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1107_xrec.html">Объект xRec</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="1110_lost_updates_protection.html">Защита от потерянных обновлений</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1120_meta.html">Метаданные Celesta</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1130_celesta_unit.html">CelestaUnit</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="2005_best_practices.html">Лучшие практики написания кода Celesta</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="2010_supported_rdbms.html">Особенности работы Celesta с поддерживаемыми типами СУБД</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="2020_dbschema.html">Проектирование базы данных Celesta в DBSchema</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Челеста</span>
    <span class="version">7</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../mellophone/2/general.html">Мелофон</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../mellophone/2/general.html">2</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../doc/1/st2-ui-state-in-url.html">Платформа КУРС</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../doc/1/st2-ui-state-in-url.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="1010_what_is_celesta.html">Челеста</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="1010_what_is_celesta.html">7</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../doc/1/general.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="1010_what_is_celesta.html">Челеста</a></li>
    <li><a href="1110_lost_updates_protection.html">Защита от потерянных обновлений</a></li>
  </ul>
</nav>
<!--  -->
<!--  -->
<!--  <div class="edit-this-page"><a href="file:///usr/src/app/target/doc/components/celesta/target/antora/modules/ROOT/pages/1110_lost_updates_protection.adoc">Редактировать страницу</a></div>-->
<!--  -->
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Содержание" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Защита от потерянных обновлений</h1>
<div class="sect1">
<h2 id="_что_такое_потерянное_обновление_lost_update">
<a class="anchor" href="#_%D1%87%D1%82%D0%BE_%D1%82%D0%B0%D0%BA%D0%BE%D0%B5_%D0%BF%D0%BE%D1%82%D0%B5%D1%80%D1%8F%D0%BD%D0%BD%D0%BE%D0%B5_%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_lost_update"></a>1. Что такое потерянное обновление (lost update)?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Чтобы проиллюстрировать понятие «потерянное обновление», рассмотрим следующий сценарий.</p>
</div>
<div class="paragraph">
<p>Допустим, в приложении имеется таблица с перечнем клиентов и пользователи могут редактировать эту таблицу через формы-карточки.
Пусть события развиваются в следующей последовательности:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Пользователь А открывает карточку клиента для того, чтобы отредактировать его почтовый индекс.</p>
</li>
<li>
<p>Пользователь Б независимо от пользователя А на своей машине открывает карточку клиента для того, чтобы отредактировать значение его кредитного лимита.</p>
</li>
<li>
<p>Пользователь Б, изменив значение поля «кредитный лимит», сохраняет карточку.
В базу данных записалась информация от пользователя Б, но пользователь А продолжает работу со своей копией карточки, где значение поля «кредитный лимит» ещё не обновилось.</p>
</li>
<li>
<p>Пользователь А заканчивает редактировать почтовый индекс клиента и сохраняет свою копию карточки.
В базу данных сохраняются все поля карточки, в том числе старый кредитный лимит.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>В итоге получается, что работа пользователя Б потеряна!</p>
</div>
<div class="paragraph">
<p>Это наиболее расхожий пример, но на самом деле, разработчик решения может столкнуться с потерянными обновлениями и в гораздо более тривиальном случае, не в рамках многопользовательской работы.
Предположим, что для модификации одной и той же таблицы используются два курсора:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooTableCursor rec1 = new FooTableCursor(context);
FooTableCursor rec2 = new FooTableCursor(context);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Пусть в некий момент оба курсора получают данные об одной и той же записи, например, таким образом:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">rec1.get(1);
rec2.copyFieldsFrom(rec1);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Допустим, запись таблицы <code>FooTable</code> с id = 1 состоит всего из трёх полей:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">id</th>
<th class="tableblock halign-center valign-middle">field1</th>
<th class="tableblock halign-center valign-middle">field2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">oldvalue</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">oldvalue</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>И пусть теперь оба курсора выполняют модификации записи:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">rec1.setField1("newvalue");
rec1.update();
//в rec1 и в базе данных уже запись 1 | newvalue | oldvalue
//но в rec2 всё ещё                 1 | oldvalue | oldvalue
rec2.setField2("newvalue");
rec2.update();
//в базе данных теперь будет запись 1 | oldvalue | newvalue ???</code></pre>
</div>
</div>
<div class="paragraph">
<p>Как видим, неудачно написанный код даже в рамках однопользовательской работы может столкнуться с явлением потери обновлений.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_способы_защиты_от_потерянных_обновлений">
<a class="anchor" href="#_%D1%81%D0%BF%D0%BE%D1%81%D0%BE%D0%B1%D1%8B_%D0%B7%D0%B0%D1%89%D0%B8%D1%82%D1%8B_%D0%BE%D1%82_%D0%BF%D0%BE%D1%82%D0%B5%D1%80%D1%8F%D0%BD%D0%BD%D1%8B%D1%85_%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B9"></a>2. Способы защиты от потерянных обновлений</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Исторически для борьбы с явлением потерянного обновления сложились два метода:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Метод пессимистической блокировки (pessimistic lock) заключается в том, что при начале редактирования записи из какого-либо места в приложении, запись помечается как заблокированная, и никакой другой скрипт или пользователь не сможет начать редактирование до тех пор, пока предыдущий редактор не завершит свою работу, обновив запись или отказавшись от её редактирования.</p>
</li>
<li>
<p>Метод оптимистической блокировки (optimistic lock) заключается в том, что любому пользователю или скрипту в любое время разрешено начать редактирование записи, при этом в момент извлечения записи из базы данных извлекается и номер версии записи.
В момент сохранения записи происходит проверка: если номер сохраняемой версии совпадает с таковым в базе данных, запись сохраняется и номер версии записи в базе данных инкрементируется; если же номер сохраняемой версии меньше, чем номер версии записи в базе данных, то пользователю выдаётся ошибка с сообщением о том, что кто-то поменял запись прежде и совет прочитать запись заново.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Каждый из методов, разумеется, имеет свои недостатки.</p>
</div>
<div class="paragraph">
<p>Главным недостатком оптимистической блокировки является, конечно, то, что пользователю не удастся записать результат своей работы в базу данных, если кто-то успел выполнить обновление той же самой записи прежде.
Тем не менее, на практике это происходит в довольно редких случаях, и "страдают" от этого в основном лишь самые "нерасторопные" пользователи, у которых слишком большое время проходит от извлечения записи до завершения её редактирования.</p>
</div>
<div class="paragraph">
<p>Главным недостатком пессимистической блокировки является то, что от пользователя ожидается, что, начав редактирование записи, он явным образом завершит редактирование или откажется от него, сняв с записи блокировку.
Однако на практике, если блокировка записи продолжается слишком долго, невозможно понять, следует ли ждать завершения работы пользователя или требуется внешнее вмешательство и явное снятие блокировки силами администраторов, иначе другие пользователи не смогут работать с заблокированной записью.</p>
</div>
<div class="paragraph">
<p>В целом для систем, подобных Celesta, недостатки пессимистической блокировки являются гораздо более существенными, чем недостатки оптимистической блокировки, и поэтому Celesta использует метод оптимистической блокировки для борьбы с потерянными обновлениями.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_защита_от_потерянных_обновлений_в_celesta">
<a class="anchor" href="#_%D0%B7%D0%B0%D1%89%D0%B8%D1%82%D0%B0_%D0%BE%D1%82_%D0%BF%D0%BE%D1%82%D0%B5%D1%80%D1%8F%D0%BD%D0%BD%D1%8B%D1%85_%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B9_%D0%B2_celesta"></a>3. Защита от потерянных обновлений в Celesta</h2>
<div class="sectionbody">
<div class="paragraph">
<p>По умолчанию, всякая таблица в системе Celesta снабжается системным полем <code>recversion</code> с типом <code>INT NOT NULL</code>.</p>
</div>
<div class="paragraph">
<p>Данное поле создаётся автоматически, разработчику не следует включать это поле в <code>CREATE TABLE</code>-скрипт.
Более того, разработчик не может создать собственное поле с именем <code>recversion</code>.
Доступ к этому полю на чтение имеется через метод <code>getRecversion()</code>, как к обычному полю.</p>
</div>
<div class="paragraph">
<p>При вставке новой записи поле <code>recversion</code> принимает значение по умолчанию 1 (единица).</p>
</div>
<div class="paragraph">
<p>При обновлении записи специальный триггер базы данных проверяет тот факт, что новое значение этого поля совпадает со значением, существующим в базе данных: если совпадение установлено, поле инкрементируется, если нет — генерируется ошибка:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"> Can not update &lt;имя гранулы и таблицы&gt; ([&lt;значения полей первичного ключа&gt;]): this record has been already modified by someone. Please start updating again.</code></pre>
</div>
</div>
<div class="paragraph">
<p>В рассмотренных выше примерах Celesta выдаст ошибку и не даст отправить в базу данных запись, приводящую к потерянным обновлениям.</p>
</div>
<div class="paragraph">
<p>Иногда возникает необходимость отказаться от защиты от потерянных обновлений — например, если таблица используется только на чтение и добавление записей, или просто только на чтение.
В этом случае при создании таблицы на языке CelestaSQL необходимо использовать <a href="1050_celesta_sql.html#table_options">опцию</a> <code>WITH NO VERSION CHECK</code> после определения таблицы.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/vendor/lunr-languages.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
